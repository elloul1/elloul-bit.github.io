<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElLoul Inventory System</title>
    <!-- Assets and Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        :root { --primary: #4f46e5; --primary-darker: #4338ca; }
        .bg-primary { background-color: var(--primary); }
        .bg-primary-darker { background-color: var(--primary-darker); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .ring-primary { --tw-ring-color: var(--primary); }
        [v-cloak] { display: none; }
        .password-icon { position: absolute; top: 50%; transform: translateY(-50%); left: 1rem; cursor: pointer; color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" v-cloak>
        <!-- Auth Page (Login/Signup) -->
        <div id="auth-page" v-if="!user.isLoggedIn && !user.isPending" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
                <div class="text-center">
                    <h2 class="text-3xl font-extrabold text-gray-900">
                        {{ authMode === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب جديد' }}
                    </h2>
                </div>
                <!-- Login Form -->
                <form v-if="authMode === 'login'" @submit.prevent="handleLogin" class="space-y-6">
                    <input type="email" v-model="form.email" placeholder="البريد الإلكتروني" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <div class="relative">
                        <input :type="passwordFieldType" v-model="form.password" placeholder="كلمة المرور" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <i :class="passwordFieldType === 'password' ? 'fa-eye' : 'fa-eye-slash'" class="fas password-icon" @click="togglePasswordVisibility"></i>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input id="remember-me" v-model="form.rememberMe" type="checkbox" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                            <label for="remember-me" class="mr-2 block text-sm text-gray-900">تذكرني</label>
                        </div>
                        <div class="text-sm">
                            <a href="#" @click.prevent="handlePasswordReset" class="font-medium text-primary hover:underline">هل نسيت كلمة المرور؟</a>
                        </div>
                    </div>
                    <button type="submit" :disabled="isLoading" class="w-full flex justify-center py-3 font-semibold text-white bg-primary rounded-lg hover:bg-primary-darker transition-colors disabled:bg-gray-400">
                        <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'جاري الدخول...' : 'دخول' }}
                    </button>
                </form>
                <!-- Signup Form -->
                <form v-if="authMode === 'signup'" @submit.prevent="handleSignup" class="space-y-6">
                    <input type="text" v-model="form.name" placeholder="الاسم الكامل" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <input type="email" v-model="form.email" placeholder="البريد الإلكتروني" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <div class="relative">
                        <input :type="passwordFieldType" v-model="form.password" placeholder="كلمة المرور (6 حروف على الأقل)" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <i :class="passwordFieldType === 'password' ? 'fa-eye' : 'fa-eye-slash'" class="fas password-icon" @click="togglePasswordVisibility"></i>
                    </div>
                    <button type="submit" :disabled="isLoading" class="w-full flex justify-center py-3 font-semibold text-white bg-primary rounded-lg hover:bg-primary-darker transition-colors disabled:bg-gray-400">
                         <i v-if="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
                        {{ isLoading ? 'جاري الإنشاء...' : 'إنشاء الحساب' }}
                    </button>
                </form>

                <p class="text-center">
                    <a @click="toggleAuthMode" href="#" class="font-medium text-primary hover:underline">
                        {{ authMode === 'login' ? 'ليس لديك حساب؟ أنشئ واحدًا' : 'لديك حساب بالفعل؟ سجل الدخول' }}
                    </a>
                </p>
            </div>
        </div>

        <!-- Pending Approval Page -->
        <div id="pending-page" v-if="user.isPending" class="flex flex-col items-center justify-center min-h-screen text-center p-4">
             <div class="bg-white p-10 rounded-2xl shadow-lg">
                <i class="fas fa-clock fa-4x text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">حسابك قيد المراجعة</h1>
                <p class="mt-2 text-gray-600">شكرًا لتسجيلك! سيقوم الأدمن بمراجعة حسابك وتفعيله قريبًا.</p>
                <button @click="handleLogout" class="mt-6 px-6 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600">تسجيل الخروج</button>
            </div>
        </div>

        <!-- Inventory Page (The Main App) -->
        <div id="inventory-page" v-if="user.isLoggedIn" class="min-h-screen flex flex-col">
            <!-- Header with user info and logout -->
            <header class="bg-white shadow-md sticky top-0 z-30">
                <div class="max-w-7xl mx-auto px-4 sm:px-8">
                    <div class="flex items-center justify-between h-16">
                         <div class="flex items-center">
                            <span class="font-bold text-xl text-primary">نظام المخزن</span>
                         </div>
                        <div class="flex items-center">
                            <span class="text-gray-700 mr-4">أهلاً، {{ user.name || user.email }}</span>
                             <button v-if="user.role === 'admin'" @click="showAdminPanel" class="mr-4 px-3 py-1 text-sm font-semibold text-white bg-green-500 rounded-full hover:bg-green-600" title="لوحة التحكم">
                                <i class="fas fa-user-shield"></i>
                            </button>
                            <button @click="handleLogout" class="px-3 py-1 text-sm font-semibold text-white bg-red-500 rounded-full hover:bg-red-600" title="تسجيل الخروج">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Admin Panel (Modal) -->
            <div v-if="adminPanel.isOpen" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center" @click.self="closeAdminPanel">
                 <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-xl font-bold">لوحة تحكم الأدمن</h3>
                        <button @click="closeAdminPanel" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="p-4 overflow-y-auto">
                        <h4 class="font-bold mb-2">المستخدمون المسجلون</h4>
                        <ul>
                            <li v-for="u in adminPanel.users" :key="u.uid" class="flex items-center justify-between p-2 hover:bg-gray-100 rounded">
                                <div>
                                    <p class="font-semibold">{{ u.name }} ({{ u.email }})</p>
                                    <p class="text-sm" :class="{'text-green-600': u.status === 'approved', 'text-yellow-600': u.status === 'pending', 'text-red-600': u.role === 'admin'}">
                                        الحالة: {{ u.status }} | الصلاحية: {{ u.role || 'user' }}
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                     <button v-if="u.status === 'pending'" @click="approveUser(u.uid)" class="px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600">موافقة</button>
                                     <button @click="deleteUser(u.uid)" class="px-2 py-1 text-xs text-white bg-red-500 rounded hover:bg-red-600">حذف</button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- The rest of the inventory app UI will be integrated here later -->
             <main class="flex-1 w-full max-w-7xl mx-auto p-4 sm:p-8">
                <div class="text-center py-20">
                    <h1 class="text-4xl font-bold">مرحباً بك في نظام المخزن</h1>
                    <p class="mt-4 text-lg text-gray-600">سيتم دمج واجهة المخزن هنا في الخطوات القادمة.</p>
                </div>
             </main>
             <button id="addProductBtn" class="fixed bottom-8 right-8 bg-primary hover:bg-primary-darker text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl z-20">
                <i class="fas fa-plus"></i>
             </button>
        </div>
    </div>

    <!-- Vue.js and Firebase SDKs -->
    <script src="https://unpkg.com/vue@3"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgzhSlzeVlqTrqefTP0rqAnlzBEKEDm6o",
            authDomain: "elloul-e82d8.firebaseapp.com",
            projectId: "elloul-e82d8",
            storageBucket: "elloul-e82d8.appspot.com",
            messagingSenderId: "190409612659",
            appId: "1:190409612659:web:cffcb1c4615502ee347906"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        const app = Vue.createApp({
            data() {
                return {
                    authMode: 'login', // 'login' or 'signup'
                    form: { name: '', email: '', password: '', rememberMe: false },
                    user: { isLoggedIn: false, isPending: false, data: null, name: '', email: '', role: '', uid: ''},
                    adminPanel: { isOpen: false, users: [] },
                    unsubscribeUsers: null,
                    passwordFieldType: 'password',
                    isLoading: false,
                }
            },
            methods: {
                toggleAuthMode() {
                    this.authMode = this.authMode === 'login' ? 'signup' : 'login';
                    this.form = { name: '', email: '', password: '', rememberMe: false };
                },
                togglePasswordVisibility() {
                    this.passwordFieldType = this.passwordFieldType === 'password' ? 'text' : 'password';
                },
                async handleLogin() {
                    this.isLoading = true;
                    try {
                        const persistence = this.form.rememberMe ? browserLocalPersistence : browserSessionPersistence;
                        await setPersistence(auth, persistence);
                        await signInWithEmailAndPassword(auth, this.form.email, this.form.password);
                    } catch (error) {
                        Swal.fire('خطأ', 'البريد الإلكتروني أو كلمة المرور غير صحيحة.', 'error');
                        console.error("Login Error:", error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async handleSignup() {
                    this.isLoading = true;
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, this.form.email, this.form.password);
                        await setDoc(doc(db, "users", userCredential.user.uid), {
                            name: this.form.name,
                            email: this.form.email,
                            uid: userCredential.user.uid,
                            role: 'user',
                            status: 'pending',
                            createdAt: new Date()
                        });
                    } catch (error) {
                        Swal.fire('خطأ', 'حدث خطأ أثناء إنشاء الحساب. تأكد أن كلمة المرور 6 حروف على الأقل.', 'error');
                        console.error("Signup Error:", error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async handlePasswordReset() {
                    const { value: email } = await Swal.fire({
                        title: 'إعادة تعيين كلمة المرور',
                        input: 'email',
                        inputLabel: 'البريد الإلكتروني المسجل به',
                        inputPlaceholder: 'ادخل بريدك الإلكتروني',
                        showCancelButton: true,
                        confirmButtonText: 'إرسال رابط الاستعادة',
                        cancelButtonText: 'إلغاء'
                    });

                    if (email) {
                        try {
                            await sendPasswordResetEmail(auth, email);
                            Swal.fire('تم الإرسال!', 'تفقد بريدك الإلكتروني للحصول على رابط إعادة التعيين.', 'success');
                        } catch (error) {
                            Swal.fire('خطأ', 'لم نتمكن من إرسال البريد. تأكد من صحة العنوان.', 'error');
                            console.error("Password Reset Error:", error);
                        }
                    }
                },
                handleLogout() {
                    signOut(auth);
                },
                async showAdminPanel() { /* ... unchanged ... */ },
                closeAdminPanel() { /* ... unchanged ... */ },
                async approveUser(uid) { /* ... unchanged ... */ },
                async deleteUser(uid) { /* ... unchanged ... */ }
            },
            mounted() {
                onAuthStateChanged(auth, async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDocRef = doc(db, "users", firebaseUser.uid);
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.status === 'approved') {
                                this.user = { isLoggedIn: true, isPending: false, data: firebaseUser, name: userData.name, email: userData.email, role: userData.role, uid: userData.uid };
                            } else {
                                this.user = { isLoggedIn: false, isPending: true, data: null, name: '', email: '', role: ''};
                            }
                        } else {
                             this.user.isPending = true;
                             this.user.isLoggedIn = false;
                        }
                    } else {
                        this.user = { isLoggedIn: false, isPending: false, data: null, name: '', email: '', role: '' };
                        if (this.unsubscribeUsers) this.unsubscribeUsers();
                    }
                });
            }
        });

        app.mount('#app');
    </script>
</body>
</html>

