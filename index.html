<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4f46e5">
    <title>ElLoul Inventory System</title>
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Tajawal -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SweetAlert2 for Interactive Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        :root { 
            --primary: #4f46e5; --primary-darker: #4338ca; --light-bg: #f0f2f5;
            --card-bg: #ffffff; --border-color: #e5e7eb; --text-dark: #111827; --text-muted: #6b7280;
        }
        .text-primary { color: var(--primary); } .bg-primary { background-color: var(--primary); }
        .bg-primary-darker { background-color: var(--primary-darker); }
        .border-primary { border-color: var(--primary); } .ring-primary { --tw-ring-color: var(--primary); }

        .header-glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        
        .product-card { 
            --glow-color: var(--primary);
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color);
            border-top-width: 4px;
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative; /* For action buttons positioning */
        }
        .product-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.12), 0 0 25px -5px var(--glow-color);
        }
        
        /* Action buttons styling and hover effect */
        .card-actions {
            position: absolute;
            top: 170px; /* Position below the image area */
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .product-card:hover .card-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .action-btn {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: color 0.2s, background-color 0.2s;
        }
        .action-btn:hover { color: white; }
        .action-btn.edit-btn:hover { background-color: var(--primary); }
        .action-btn.delete-btn:hover { background-color: #ef4444; }

        .custom-scrollbar::-webkit-scrollbar { height: 4px; } 
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } 
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .swal2-popup { border-radius: 1rem !important; font-family: 'Tajawal', sans-serif; }
        .swal2-confirm { background-color: var(--primary) !important; box-shadow: none !important; }
        .swal2-deny { background-color: #ef4444 !important; box-shadow: none !important; }

        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .product-card-fade-in { animation: cardFadeIn 0.6s ease-out forwards; }
        
        .image-placeholder {
            height: 160px; display: flex; align-items: center; justify-content: center;
            background-color: #f9fafb; border-bottom: 1px dashed var(--border-color);
            cursor: pointer; transition: background-color 0.3s, border-color 0.3s;
        }
        .image-placeholder:hover { background-color: #eef2ff; }
        .image-placeholder.dragover { border: 2px dashed var(--primary); background-color: #eef2ff; }
        
        .product-image { height: 160px; width: 100%; object-fit: cover; }

        .category-tabs-container {
            display: flex; overflow-x: auto; padding-bottom: 8px; white-space: nowrap; -webkit-overflow-scrolling: touch;
        }
        .category-tab {
            flex-shrink: 0; display: inline-flex; align-items: center; cursor: pointer;
            padding: 0.5rem 1.25rem; margin: 0.25rem; border-radius: 9999px;
            background-color: #f3f4f6; color: #374151; font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .category-tab:hover { background-color: #e5e7eb; color: var(--primary); }
        .category-tab.active {
            background-color: var(--primary); color: white;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .category-tab i { margin-left: 8px; }
        #current-category-title { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="text-text-dark bg-light-bg">

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="header-glass sticky top-0 z-30">
            <div class="flex items-center justify-center h-20 max-w-7xl mx-auto px-4 sm:px-8 w-full">
                <div class="relative w-full max-w-sm">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-4"><i class="fas fa-search text-gray-400"></i></span>
                    <input id="searchInput" type="text" placeholder="ابحث في كل الأصناف..." class="w-full pl-12 pr-10 py-3 bg-gray-100 border-2 border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-text-dark transition-all duration-300">
                    <button id="clearSearchBtn" class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-500 hover:text-primary hidden transition-opacity duration-300"><i class="fas fa-times-circle"></i></button>
                </div>
            </div>
        </header>
        
        <!-- Category Tabs -->
        <div class="bg-white border-b border-border-color sticky top-20 z-20">
            <div id="category-tabs-container" class="category-tabs-container max-w-7xl mx-auto px-2 sm:px-6 custom-scrollbar">
                <!-- Tabs will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 w-full max-w-7xl mx-auto p-4 sm:p-8">
            <div id="home-page">
                <h2 id="current-category-title" class="text-3xl font-extrabold text-text-dark mb-8">كل الأصناف</h2>
                <div id="loader" class="text-center py-20"><i class="fas fa-spinner fa-spin text-primary text-5xl"></i><p class="mt-4 text-text-muted text-xl">جاري تهيئة قاعدة البيانات...</p></div>
                <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
                <div id="no-results" class="hidden text-center text-text-muted py-20"><i class="far fa-surprise text-7xl mb-4"></i><p class="text-3xl font-semibold text-gray-500">لا توجد نتائج مطابقة</p></div>
                <!-- Lazy Loading Indicators -->
                <div id="lazy-loader" class="hidden text-center py-10"><i class="fas fa-spinner fa-spin text-primary text-3xl"></i></div>
                <div id="sentinel" class="w-full h-10"></div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center py-6 border-t border-border-color relative">
            <p class="text-text-muted">صنع بواسطة <span id="footer-brand-link" class="font-bold text-primary cursor-pointer hover:underline">ElLoul</span> &copy; <span id="current-year"></span></p>
            
            <div id="social-popup" class="hidden absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 z-50 text-right">
                <div class="p-2">
                    <ul class="space-y-1">
                        <li><a href="https://www.facebook.com/AliMamdouhh369?mibextid=ZbWKwL" target="_blank" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-primary transition-colors duration-200"><i class="fab fa-facebook text-2xl w-8 text-center" style="color: #1877F2;"></i><span class="mr-3 font-semibold">فيسبوك</span></a></li>
                        <li><a href="https://api.WhatsApp.com/send?phone=+201206796831&text=سـجـلـنـي%20『乇ㄥㄥㄖㄥㄥ』بـقـى%20يـصـاحـبـي.%20ᥫ᭡" target="_blank" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-primary transition-colors duration-200"><i class="fab fa-whatsapp text-2xl w-8 text-center" style="color: #25D366;"></i><span class="mr-3 font-semibold">واتساب</span></a></li>
                        <li><a href="https://m.me/AliMamdouhh369" target="_blank" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-primary transition-colors duration-200"><i class="fab fa-facebook-messenger text-2xl w-8 text-center" style="color: #00B2FF;"></i><span class="mr-3 font-semibold">مسنجر</span></a></li>
                        <li><a href="https://www.instagram.com/alimamdouhhh369/" target="_blank" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-primary transition-colors duration-200"><i class="fab fa-instagram text-2xl w-8 text-center" style="color: #E4405F;"></i><span class="mr-3 font-semibold">انستجرام</span></a></li>
                        <li><a href="https://t.me/AliMamdouhh369" target="_blank" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-primary transition-colors duration-200"><i class="fab fa-telegram text-2xl w-8 text-center" style="color: #0088cc;"></i><span class="mr-3 font-semibold">تليجرام</span></a></li>
                        <li><a href="https://tiktok.com/@alimamdouhh369" target="_blank" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 hover:text-primary transition-colors duration-200"><i class="fab fa-tiktok text-2xl w-8 text-center" style="color: #010101;"></i><span class="mr-3 font-semibold">تيك توك</span></a></li>
                    </ul>
                </div>
            </div>
        </footer>
        
        <!-- Floating Action Button -->
        <button id="addProductBtn" class="fixed bottom-8 right-8 bg-primary hover:bg-primary-darker text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl z-40 transition-transform transform hover:scale-110">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                // --- Configuration & State ---
                db: null,
                observer: null,
                state: {
                    fullInventory: [],
                    categorizedProducts: {},
                    currentFilteredList: [],
                    displayOffset: 0,
                },
                config: {
                    DATA_URL: 'https://raw.githubusercontent.com/elloul369-bit/Mohamed-mamdouh/refs/heads/main/text%201.json',
                    CARD_COLORS: ['#3b82f6', '#22c55e', '#ef4444', '#a855f7', '#ec4899', '#f97316', '#14b8a6', '#6366f1'],
                    BATCH_SIZE: 40,
                    CATEGORY_KEYWORDS: {
                        'العناية بالشعر': ['شامبو', 'بلسم', 'زيت', 'كريم شعر', 'صبغه', 'جل', 'جيل', 'حمام كريم', 'سيرم', 'هير', 'فاتيكا', 'صانسيلk', 'لوريال', 'بانتين', 'كلير', 'دابر املا', 'ترزمي', 'باليت', 'فرد شعر', 'ملمع', 'اي كرياتين', 'هيربال ايسنز', 'تريشوب', 'كازانوفا'],
                        'العناية بالبشرة': ['كريم', 'غسول', 'ماسك', 'صابون', 'لوشن', 'مرطب', 'تفتيح', 'واقي', 'صنفره', 'جلسرين', 'نيفيا', 'دوف', 'ايفا', 'غارنيه', 'فازلين', 'اسیتون', 'مزيل مكياج', 'بي وايت', 'سكين كلينيك', 'كولاجين', 'جليسوليد', 'سبوتليس', 'ديرما'],
                        'العناية بالطفل': ['بيبي', 'اطفال', 'نونو', 'بامبرز', 'مولفكس', 'فاين بيبي', 'ببرونه', 'سكاته', 'حفاضه', 'جونسون', 'بندولين', 'اي باتش اطفال', 'سانوسان', 'كيدز', 'سيتي بيبي'],
                        'العناية الشخصية': ['مزيل', 'سبراي', 'معجون', 'فرشاة اسنان', 'شفره', 'حلاقه', 'جيليت', 'لورد', 'اكس', 'ريكسونا', 'فا', 'سويت', 'واكس', 'فوط', 'الويز', 'سوفي', 'برايفت', 'مولبيد', 'بودره', 'ديتول', 'معطر فم', 'سيجنال', 'سنسوداين', 'كلوس اب', 'خيط اسنان', 'عازل طبي'],
                        'مستلزمات طبية': ['بلاستر', 'شاش', 'قطن', 'رباط', 'سرنجة', 'جهاز ضغط', 'ترمومتر', 'كمامة', 'كحول', 'بيتادين', 'قسطرة', 'جبيرة', 'حزام', 'انكل', 'ركبه', 'كوع', 'فيكريل', 'برولين', 'كانيولا', 'دريسنج', 'قربة', 'مبوله'],
                        'العطور': ['برفان', 'كولونيا', 'عطر', 'اسبلاش', 'فوج'],
                        'المنزل والمبيدات': ['بايجون', 'ريد', 'جليد', 'ملمع', 'مناديل', 'ديتول', 'راجون', 'كيروكس', 'لزقة فار', 'صراصير']
                    },
                    CATEGORY_ICONS: {'كل الأصناف':'fa-boxes-stacked','العناية بالشعر':'fa-cut','العناية بالبشرة':'fa-spa','العناية بالطفل':'fa-baby','العناية الشخصية':'fa-user-shield','مستلزمات طبية':'fa-briefcase-medical','العطور':'fa-spray-can-sparkles','المنزل والمبيدات':'fa-bug-slash','متنوع':'fa-shapes'},
                },
                elements: {
                    categoryTabsContainer: document.getElementById('category-tabs-container'),
                    inventoryGrid: document.getElementById('inventory-grid'),
                    searchInput: document.getElementById('searchInput'),
                    clearSearchBtn: document.getElementById('clearSearchBtn'),
                    noResults: document.getElementById('no-results'),
                    loader: document.getElementById('loader'),
                    lazyLoader: document.getElementById('lazy-loader'),
                    sentinel: document.getElementById('sentinel'),
                    currentCategoryTitle: document.getElementById('current-category-title'),
                    addProductBtn: document.getElementById('addProductBtn'),
                    footerBrandLink: document.getElementById('footer-brand-link'),
                    socialPopup: document.getElementById('social-popup'),
                    currentYear: document.getElementById('current-year'),
                },

                // --- App Initialization ---
                async init() {
                    this.setupDatabase();
                    await this.loadData();
                    if (this.state.fullInventory.length > 0) {
                        this.processAndCategorize(this.state.fullInventory);
                        this.updateCategoryTabs();
                        this.handleFilter();
                        this.elements.loader.classList.add('hidden');
                    }
                    this.setupEventListeners();
                    this.setupObserver();
                },
                
                setupDatabase() {
                    this.db = new Dexie('InventoryDB');
                    this.db.version(2).stores({ products: '++id, الصنف, السعر, صورة' });
                },
                
                async loadData() {
                    const productCount = await this.db.products.count();
                    if (productCount === 0) {
                        this.elements.loader.querySelector('p').textContent = 'جاري جلب البيانات لأول مرة...';
                        try {
                            const response = await fetch(this.config.DATA_URL);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            const initialData = await response.json();
                            await this.db.products.bulkAdd(initialData);
                        } catch (error) {
                            console.error("Failed to fetch and populate DB:", error);
                            this.elements.loader.innerHTML = '<p class="text-red-500">فشل تحميل البيانات الأولية. تحقق من اتصال الإنترنت.</p>';
                        }
                    }
                    this.state.fullInventory = await this.db.products.toArray();
                },

                // --- Event Listeners ---
                setupEventListeners() {
                    this.elements.searchInput.addEventListener('input', this.handleSearchInput.bind(this));
                    this.elements.clearSearchBtn.addEventListener('click', this.clearSearch.bind(this));
                    this.elements.categoryTabsContainer.addEventListener('click', this.handleCategoryClick.bind(this));
                    this.elements.inventoryGrid.addEventListener('click', this.handleGridClick.bind(this));
                    this.elements.addProductBtn.addEventListener('click', () => this.showProductModal());
                    this.elements.currentYear.textContent = new Date().getFullYear();
                    this.setupImageDropHandler();
                    this.setupSocialPopup();
                },

                // --- Rendering ---
                renderProductBatch(items) {
                    const fragment = document.createDocumentFragment();
                    items.forEach((item, index) => {
                        const color = this.config.CARD_COLORS[(this.state.displayOffset + index) % this.config.CARD_COLORS.length];
                        const card = document.createElement('div');
                        card.className = 'product-card flex flex-col rounded-lg product-card-fade-in';
                        card.style.borderTopColor = color;
                        card.style.setProperty('--glow-color', color + '99');
                        card.dataset.productId = item.id;
                        
                        const category = this.getCategory(item['الصنف']);
                        const showCategory = this.elements.searchInput.value.trim().length > 0;

                        const imagePart = item.صورة 
                            ? `<img src="${item.صورة}" class="product-image" alt="${item['الصنف']}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x200/eef2ff/4f46e5?text=Invalid%20Image';">`
                            : `<div class="image-placeholder" data-id="${item.id}">
                                   <div class="text-center text-text-muted pointer-events-none">
                                       <i class="fas fa-camera text-5xl"></i>
                                       <p class="mt-2 text-sm font-semibold">إضافة صورة</p>
                                   </div>
                               </div>`;

                        card.innerHTML = `
                            ${imagePart}
                            <div class="card-actions">
                                <button class="action-btn edit-btn" data-id="${item.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" data-id="${item.id}" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="p-4 flex flex-col flex-grow">
                                ${showCategory ? `<p class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: ${color};">${category}</p>` : ''}
                                <h3 class="font-bold text-text-dark text-lg h-14 leading-tight flex-grow">${this.escapeHtml(item['الصنف'])}</h3>
                                <div class="flex justify-between items-center mt-4">
                                    <p class="text-primary text-2xl font-black">${Number(item['السعر']).toFixed(2)} <span class="text-sm font-medium text-text-muted">جم</span></p>
                                </div>
                            </div>`;
                        fragment.appendChild(card);
                    });
                    this.elements.inventoryGrid.appendChild(fragment);
                },

                updateCategoryTabs() {
                    const categoryOrder = ['كل الأصناف', ...Object.keys(this.config.CATEGORY_KEYWORDS), 'متنوع'];
                    this.elements.categoryTabsContainer.innerHTML = '';
                    const activeCategory = this.elements.categoryTabsContainer.querySelector('.active')?.dataset.category || 'كل الأصناف';

                    categoryOrder.forEach(category => {
                        const products = this.state.categorizedProducts[category];
                        if (products && products.length > 0) {
                            const tab = document.createElement('button');
                            tab.className = 'category-tab';
                            tab.dataset.category = category;
                            const iconClass = this.config.CATEGORY_ICONS[category] || 'fa-tag';
                            tab.innerHTML = `<i class="fas ${iconClass}"></i><span>${category} (${products.length})</span>`;
                            if (category === activeCategory) {
                               tab.classList.add('active');
                            }
                            this.elements.categoryTabsContainer.appendChild(tab);
                        }
                    });

                    if (!this.elements.categoryTabsContainer.querySelector('.active')) {
                        this.elements.categoryTabsContainer.querySelector('.category-tab')?.classList.add('active');
                    }
                },
                
                updateCategoryTitle() {
                    const searchTerm = this.elements.searchInput.value.trim();
                    const activeTab = this.elements.categoryTabsContainer.querySelector('.category-tab.active');
                    const activeCategory = activeTab?.dataset.category || 'كل الأصناف';
                    
                    this.elements.currentCategoryTitle.style.opacity = 0;
                    setTimeout(() => {
                        if (searchTerm) {
                            this.elements.currentCategoryTitle.innerHTML = `نتائج البحث عن: "<span class="text-primary">${this.escapeHtml(searchTerm)}</span>" <span class="text-gray-500 font-normal text-2xl">(${this.state.currentFilteredList.length} منتج)</span>`;
                        } else {
                            this.elements.currentCategoryTitle.innerHTML = `${activeCategory} <span class="text-gray-500 font-normal text-2xl">(${this.state.currentFilteredList.length} منتج)</span>`;
                        }
                        this.elements.currentCategoryTitle.style.opacity = 1;
                    }, 300);
                },

                // --- Logic & Filtering ---
                getCategory(productName) {
                    const lowerCaseName = productName.toLowerCase();
                    // Specific overrides for ambiguous names
                    if (lowerCaseName.includes('كريم') && (lowerCaseName.includes('شعر') || lowerCaseName.includes('هير'))) return 'العناية بالشعر';
                    if (lowerCaseName.includes('جونسون') || lowerCaseName.includes('بامبرz') || lowerCaseName.includes('مولفكس')) return 'العناية بالطفل';
                    
                    for (const category in this.config.CATEGORY_KEYWORDS) {
                        if (this.config.CATEGORY_KEYWORDS[category].some(keyword => lowerCaseName.includes(keyword))) return category;
                    }
                    return 'متنوع';
                },

                processAndCategorize(data) {
                    const categories = { 'كل الأصناف': [...data] };
                    Object.keys(this.config.CATEGORY_KEYWORDS).forEach(cat => categories[cat] = []);
                    categories['متنوع'] = [];
                    data.forEach(product => {
                        const category = this.getCategory(product['الصنف']);
                        categories[category].push(product);
                    });
                    this.state.categorizedProducts = categories;
                },

                handleFilter() {
                    const searchTerm = this.elements.searchInput.value.toLowerCase().trim();
                    const activeTab = this.elements.categoryTabsContainer.querySelector('.category-tab.active');
                    const activeCategory = activeTab?.dataset.category || 'كل الأصناف';
                    
                    let sourceList;
                    if (searchTerm) {
                        sourceList = this.state.fullInventory.filter(item => item['الصنف'].toLowerCase().includes(searchTerm));
                    } else {
                        sourceList = this.state.categorizedProducts[activeCategory] || [];
                    }

                    this.state.currentFilteredList = sourceList;
                    this.elements.inventoryGrid.innerHTML = '';
                    this.state.displayOffset = 0; 
                    
                    this.elements.noResults.classList.toggle('hidden', this.state.currentFilteredList.length > 0);
                    
                    this.updateCategoryTitle();

                    if (this.observer) {
                        this.observer.unobserve(this.elements.sentinel);
                        if (this.state.currentFilteredList.length > this.config.BATCH_SIZE) {
                            this.observer.observe(this.elements.sentinel);
                        }
                    }
                    this.loadMoreItems();
                },

                // --- Lazy Loading ---
                loadMoreItems() {
                    if (this.state.displayOffset >= this.state.currentFilteredList.length) {
                        this.elements.lazyLoader.classList.add('hidden');
                        return;
                    }
                    this.elements.lazyLoader.classList.remove('hidden');
                    const batch = this.state.currentFilteredList.slice(this.state.displayOffset, this.state.displayOffset + this.config.BATCH_SIZE);
                    
                    if (batch.length > 0) {
                        this.renderProductBatch(batch);
                        this.state.displayOffset += this.config.BATCH_SIZE;
                    }
                    if (this.state.displayOffset >= this.state.currentFilteredList.length) {
                        if (this.observer) this.observer.unobserve(this.elements.sentinel);
                    }
                    this.elements.lazyLoader.classList.add('hidden');
                },
                
                setupObserver() {
                    const observerCallback = (entries) => {
                        if (entries[0].isIntersecting) {
                            this.loadMoreItems();
                        }
                    };
                    this.observer = new IntersectionObserver(observerCallback, { rootMargin: "0px 0px 400px 0px" });
                    if (this.state.currentFilteredList.length > this.config.BATCH_SIZE) {
                        this.observer.observe(this.elements.sentinel);
                    }
                },
                
                // --- CRUD Operations (Optimized) ---
                async addProduct(newProduct) {
                    const id = await this.db.products.add(newProduct);
                    const productWithId = { ...newProduct, id };

                    // Update local state
                    this.state.fullInventory.push(productWithId);
                    const category = this.getCategory(productWithId['الصنف']);
                    this.state.categorizedProducts['كل الأصناف'].push(productWithId);
                    this.state.categorizedProducts[category]?.push(productWithId);

                    this.updateCategoryTabs();
                    this.handleFilter(); // Refresh current view
                },

                async updateProduct(updatedProduct) {
                    await this.db.products.put(updatedProduct);

                    // Re-fetch and re-categorize for simplicity and accuracy after an update
                    this.state.fullInventory = await this.db.products.toArray();
                    this.processAndCategorize(this.state.fullInventory);

                    this.updateCategoryTabs();
                    this.handleFilter(); // Refresh current view
                },
                
                async deleteProduct(productId) {
                    const productToDelete = this.state.fullInventory.find(p => p.id === productId);
                    const result = await Swal.fire({
                        title: 'هل أنت متأكد؟',
                        text: `سيتم حذف "${this.escapeHtml(productToDelete['الصنف'])}" بشكل نهائي!`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#ef4444',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'نعم، احذفه!',
                        cancelButtonText: 'إلغاء'
                    });

                    if (result.isConfirmed) {
                        await this.db.products.delete(productId);
                        
                        // Update state
                        this.state.fullInventory = this.state.fullInventory.filter(p => p.id !== productId);
                        this.processAndCategorize(this.state.fullInventory); // Recategorize after deletion

                        this.updateCategoryTabs();
                        this.handleFilter(); // Refresh view
                        Swal.fire({icon:'success', title:'تم الحذف!', text:'تم حذف الصنف بنجاح.', timer: 1500, showConfirmButton: false});
                    }
                },

                // --- Event Handlers ---
                handleSearchInput(e) {
                    this.elements.clearSearchBtn.classList.toggle('hidden', e.target.value === '');
                    this.elements.categoryTabsContainer.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                    this.handleFilter();
                },

                clearSearch() {
                    this.elements.searchInput.value = '';
                    this.elements.clearSearchBtn.classList.add('hidden');
                    this.elements.categoryTabsContainer.querySelector('.category-tab[data-category="كل الأصناف"]')?.classList.add('active');
                    this.handleFilter();
                },
                
                handleCategoryClick(e) {
                    const target = e.target.closest('.category-tab');
                    if (target) {
                        this.elements.categoryTabsContainer.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                        target.classList.add('active');
                        target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        this.elements.searchInput.value = '';
                        this.elements.clearSearchBtn.classList.add('hidden');
                        this.handleFilter();
                    }
                },
                
                handleGridClick(e) {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    const imgPlaceholder = e.target.closest('.image-placeholder');
                    
                    const id = parseInt(editBtn?.dataset.id || deleteBtn?.dataset.id || imgPlaceholder?.dataset.id);
                    if (!id) return;
                    
                    const product = this.state.fullInventory.find(p => p.id === id);
                    if (!product) return;

                    if (editBtn) this.showProductModal(product);
                    else if (deleteBtn) this.deleteProduct(product.id);
                    else if (imgPlaceholder) this.showImageModal(product);
                },

                setupImageDropHandler() {
                     ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                         this.elements.inventoryGrid.addEventListener(eventName, e => {
                             const imgPlaceholder = e.target.closest('.image-placeholder');
                             if (!imgPlaceholder) return;
                             
                             e.preventDefault();
                             if (eventName === 'dragover') imgPlaceholder.classList.add('dragover');
                             if (eventName === 'dragleave' || eventName === 'drop') imgPlaceholder.classList.remove('dragover');
                             
                             if (eventName === 'drop') {
                                 const product = this.state.fullInventory.find(p => p.id === parseInt(imgPlaceholder.dataset.id));
                                 if (product && e.dataTransfer.files.length) {
                                     const file = e.dataTransfer.files[0];
                                     if (file && file.type.startsWith('image/')) {
                                         const reader = new FileReader();
                                         reader.onload = async (event) => {
                                             const updatedProduct = { ...product, صورة: event.target.result };
                                             await this.updateProduct(updatedProduct);
                                             Swal.fire({icon:'success', title:'تم!', text:'تمت إضافة الصورة بنجاح.', timer: 1500, showConfirmButton: false});
                                         };
                                         reader.readAsDataURL(file);
                                     }
                                 }
                             }
                         });
                     });
                },

                setupSocialPopup() {
                    this.elements.footerBrandLink.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.elements.socialPopup.classList.toggle('hidden');
                    });
                    window.addEventListener('click', (e) => {
                        if (!this.elements.socialPopup.classList.contains('hidden') && e.target.id !== 'footer-brand-link' && !this.elements.socialPopup.contains(e.target)) {
                            this.elements.socialPopup.classList.add('hidden');
                        }
                    });
                },

                // --- Modals (Refactored) ---
                async showProductModal(product = null) {
                    const isEditing = product !== null;
                    const { value: formValues } = await Swal.fire({
                        title: isEditing ? 'تعديل الصنف' : 'إضافة صنف جديد',
                        html:
                            `<input id="swal-input-name" class="swal2-input" placeholder="اسم الصنف" value="${isEditing ? this.escapeHtml(product['الصنف']) : ''}">` +
                            `<input id="swal-input-price" class="swal2-input" type="number" step="0.01" placeholder="السعر" value="${isEditing ? product['السعر'] : ''}">`,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: isEditing ? 'حفظ التعديلات' : 'إضافة',
                        cancelButtonText: 'إلغاء',
                        preConfirm: () => ({
                            'الصنف': document.getElementById('swal-input-name').value,
                            'السعر': parseFloat(document.getElementById('swal-input-price').value)
                        })
                    });

                    if (formValues) {
                        if (!formValues['الصنف'] || isNaN(formValues['السعر']) || formValues['السعر'] < 0) {
                            Swal.fire('خطأ', 'الرجاء إدخال اسم وسعر صحيحين.', 'error');
                            return;
                        }

                        if (isEditing) {
                            await this.updateProduct({ ...product, ...formValues });
                            Swal.fire({icon:'success', title:'تم!', text:'تم تحديث بيانات الصنف بنجاح.', timer: 1500, showConfirmButton: false});
                        } else {
                            await this.addProduct({ ...formValues, 'صورة': '' });
                            Swal.fire({icon: 'success', title: 'تم!', text: 'تمت إضافة الصنف الجديد بنجاح.', timer: 1500, showConfirmButton: false});
                        }
                    }
                },
                
                async showImageModal(product) {
                    const { isConfirmed, isDenied, value: result } = await Swal.fire({
                        title: `صورة: ${this.escapeHtml(product['الصنف'])}`,
                        html: `
                            <div class="mb-4">
                                <img id="image-preview" src="${product.صورة || 'https://placehold.co/400x200/eef2ff/4f46e5?text=No%20Image'}" class="w-full h-48 object-contain rounded-lg mx-auto" alt="Preview">
                            </div>
                            <div id="drop-zone" class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-primary hover:bg-gray-50 transition-colors">
                                <p class="text-text-muted pointer-events-none">اسحب وأفلت صورة هنا أو انقر للاختيار</p>
                                <input type="file" id="swal-file" class="hidden" accept="image/*">
                            </div>
                            <p class="my-3 text-gray-400">أو أدخل رابط الصورة</p>
                            <input id="swal-url" class="swal2-input" placeholder="https://example.com/image.png" value="${product.صورة?.startsWith('http') ? product.صورة : ''}">`,
                        showCancelButton: true,
                        showDenyButton: !!product.صورة,
                        confirmButtonText: '<i class="fas fa-save mr-2"></i>حفظ الصورة',
                        cancelButtonText: 'إلغاء',
                        denyButtonText: '<i class="fas fa-trash-alt mr-2"></i>إزالة الصورة',
                        didOpen: () => {
                            const dropZone = document.getElementById('drop-zone');
                            const fileInput = document.getElementById('swal-file');
                            const urlInput = document.getElementById('swal-url');
                            const preview = document.getElementById('image-preview');

                            const handleFile = (file) => {
                                if (!file || !file.type.startsWith('image/')) return;
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    preview.src = e.target.result;
                                    urlInput.value = '';
                                };
                                reader.readAsDataURL(file);
                            };
                            
                            dropZone.onclick = () => fileInput.click();
                            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-primary', 'bg-indigo-50'); };
                            dropZone.ondragleave = () => dropZone.classList.remove('border-primary', 'bg-indigo-50');
                            dropZone.ondrop = (e) => {
                                e.preventDefault();
                                dropZone.classList.remove('border-primary', 'bg-indigo-50');
                                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
                            };
                            fileInput.onchange = () => handleFile(fileInput.files[0]);
                            urlInput.oninput = () => {
                                preview.src = urlInput.value || 'https://placehold.co/400x200/eef2ff/4f46e5?text=No%20Image';
                            };
                        },
                        preConfirm: () => ({
                            imageSrc: document.getElementById('image-preview').src,
                            url: document.getElementById('swal-url').value,
                        })
                    });

                    if (isConfirmed && result) {
                        const newImage = result.imageSrc.startsWith('data:image') ? result.imageSrc : result.url;
                        if (newImage && newImage !== product.صورة) {
                            await this.updateProduct({ ...product, صورة: newImage });
                            Swal.fire({icon:'success', title:'تم!', text:'تم تحديث الصورة بنجاح.', timer: 1500, showConfirmButton: false});
                        }
                    } else if (isDenied) {
                        await this.updateProduct({ ...product, صورة: '' });
                        Swal.fire({icon:'success', title:'تم!', text:'تمت إزالة الصورة بنجاح.', timer: 1500, showConfirmButton: false});
                    }
                },

                // --- Utilities ---
                escapeHtml(str) {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                },
            };

            App.init();
        });
    </script>
</body>
</html>